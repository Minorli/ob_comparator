========================================
OceanBase 报告表阅读指南（report_to_db）
========================================

目录
1. 概览
2. 入门：找到最新 report_id
3. 客户排查主线（先汇总 → 不支持 → 阻断 → remap → 缺失/不一致）
4. 汇总统计与趋势
5. 缺失/不支持/阻断/不一致明细（核心）
6. 依赖与阻断深挖
7. remap 专项
8. 黑名单与不支持原因
9. 授权差异（GRANT）
10. 可用性 / PACKAGE / TRIGGER 状态
11. 高级筛选与定位
12. 常见排查问答

----------------------------------------
1) 概览
----------------------------------------
说明
- 本文件适用于 report_to_db=true 写入 OB 的报告表。
- 写库范围受 report_db_store_scope 控制：
  - summary：仅 SUMMARY / COUNTS
  - core：summary + DETAIL / GRANT / USABILITY / PACKAGE_COMPARE / TRIGGER_STATUS
  - full：core + DETAIL_ITEM / ARTIFACT / DEPENDENCY / VIEW_CHAIN / REMAP_CONFLICT / OBJECT_MAPPING / BLACKLIST / FIXUP_SKIP / OMS_MISSING
  - 备注：WRITE_ERRORS / RESOLUTION 为写库追踪与闭环表，report_to_db 启用后默认创建
- 表名固定为：
  - DIFF_REPORT_SUMMARY
  - DIFF_REPORT_COUNTS
  - DIFF_REPORT_DETAIL
  - DIFF_REPORT_DETAIL_ITEM
  - DIFF_REPORT_GRANT
  - DIFF_REPORT_USABILITY
  - DIFF_REPORT_PACKAGE_COMPARE
  - DIFF_REPORT_TRIGGER_STATUS
  - DIFF_REPORT_ARTIFACT
  - DIFF_REPORT_DEPENDENCY
  - DIFF_REPORT_VIEW_CHAIN
  - DIFF_REPORT_REMAP_CONFLICT
  - DIFF_REPORT_OBJECT_MAPPING
  - DIFF_REPORT_BLACKLIST
  - DIFF_REPORT_FIXUP_SKIP
  - DIFF_REPORT_OMS_MISSING
  - DIFF_REPORT_WRITE_ERRORS
  - DIFF_REPORT_RESOLUTION
- 报告明细表使用列名：
  - REPORT_TYPE: MISSING / UNSUPPORTED / MISMATCHED / OK / SKIPPED
  - STATUS: 用于区分细分状态（如 BLOCKED / UNSUPPORTED / MISMATCH / OK / SKIPPED）
  - 视图（report_db_store_scope=core/full 时创建）：
    DIFF_REPORT_ACTIONS_V / DIFF_REPORT_OBJECT_PROFILE_V / DIFF_REPORT_TRENDS_V
    DIFF_REPORT_PENDING_ACTIONS_V / DIFF_REPORT_GRANT_CLASS_V / DIFF_REPORT_USABILITY_CLASS_V

----------------------------------------
2) 入门：找到最新 report_id
----------------------------------------
SELECT report_id, run_timestamp, run_dir
  FROM DIFF_REPORT_SUMMARY
 ORDER BY run_timestamp DESC
 FETCH FIRST 5 ROWS ONLY;

-- SQL 模板（预填 report_id）已输出到 run 目录：
-- report_sql_<timestamp>.txt

-- DB 覆盖范围提醒（哪些报告已入库，哪些仍在 TXT）
SELECT report_id, artifact_type, status, note, row_count, file_path
  FROM DIFF_REPORT_ARTIFACT
 WHERE report_id = :report_id
 ORDER BY artifact_type, status;

----------------------------------------
3) 客户排查主线（推荐顺序）
----------------------------------------
步骤 1: 看“检查汇总”（总览 + 按类型）
-- 总览（主表）
SELECT report_id, run_timestamp,
       total_checked, missing_count, mismatched_count, unsupported_count, skipped_count,
       conclusion, conclusion_detail
  FROM DIFF_REPORT_SUMMARY
 WHERE report_id = :report_id;

-- 按对象类型（计数表）
SELECT object_type,
       oracle_count, oceanbase_count,
       missing_count, unsupported_count, extra_count
  FROM DIFF_REPORT_COUNTS
 WHERE report_id = :report_id
 ORDER BY unsupported_count DESC, missing_count DESC, extra_count DESC;

-- 任务视图（可执行清单）
-- 说明：仅在 report_db_store_scope=core/full 时生成
SELECT action_type, object_type, schema_name, object_name, reason
  FROM DIFF_REPORT_ACTIONS_V
 WHERE report_id = :report_id
 ORDER BY action_type, object_type, schema_name, object_name;

-- 未完成清单（结合 resolution）
SELECT action_type, object_type, schema_name, object_name, reason,
       resolution_status, resolved_by, resolved_at
  FROM DIFF_REPORT_PENDING_ACTIONS_V
 WHERE report_id = :report_id
 ORDER BY action_type, object_type, schema_name, object_name;

-- 对象画像（统一看问题谱系）
-- 说明：仅在 report_db_store_scope=core/full 时生成
SELECT object_type, source_schema, source_name, detail_status, detail_reason,
       usability_status, blacklist_type
  FROM DIFF_REPORT_OBJECT_PROFILE_V
 WHERE report_id = :report_id
 ORDER BY object_type, source_schema, source_name;

步骤 2: 先看不支持（需要改造）
SELECT source_schema, source_name, target_schema, target_name,
       object_type, status, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
 ORDER BY object_type, source_schema, source_name;

步骤 3: 再看阻断（依赖/黑名单）
-- 阻断行在 UNSUPPORTED 中，status=BLOCKED
SELECT source_schema, source_name, target_schema, target_name,
       object_type, status, reason, detail_json
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
   AND status = 'BLOCKED'
 ORDER BY object_type, source_schema, source_name;

步骤 4: 定位 remap 影响
SELECT object_type, COUNT(*) AS cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND DBMS_LOB.INSTR(detail_json, 'remap') > 0
 GROUP BY object_type
 ORDER BY cnt DESC;

步骤 5: 处理缺失（可修复）
SELECT source_schema, source_name, target_schema, target_name,
       object_type, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'MISSING'
 ORDER BY object_type, source_schema, source_name;

步骤 6: 处理不一致（结构/约束/索引等）
SELECT source_schema, source_name, target_schema, target_name,
       object_type, reason, detail_json
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'MISMATCHED'
 ORDER BY object_type, target_schema, target_name;

----------------------------------------
4) 汇总统计与趋势
----------------------------------------
4.1 按对象类型汇总（计数表）
SELECT object_type,
       oracle_count, oceanbase_count,
       missing_count, unsupported_count, extra_count
  FROM DIFF_REPORT_COUNTS
 WHERE report_id = :report_id
 ORDER BY object_type;

4.2 不一致数量（按对象类型）
SELECT object_type, COUNT(*) AS mismatched_cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'MISMATCHED'
 GROUP BY object_type
 ORDER BY mismatched_cnt DESC;

4.3 按 schema 汇总（缺失/不支持/不一致）
SELECT COALESCE(source_schema, target_schema) AS schema_name,
       SUM(CASE WHEN report_type='MISSING' THEN 1 ELSE 0 END) AS missing_cnt,
       SUM(CASE WHEN report_type='UNSUPPORTED' THEN 1 ELSE 0 END) AS unsupported_cnt,
       SUM(CASE WHEN report_type='MISMATCHED' THEN 1 ELSE 0 END) AS mismatched_cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
 GROUP BY COALESCE(source_schema, target_schema)
 ORDER BY missing_cnt DESC, unsupported_cnt DESC, mismatched_cnt DESC;

4.4 多次运行趋势（按类型）
SELECT c.report_id, s.run_timestamp, c.object_type,
       c.missing_count, c.unsupported_count, c.extra_count
  FROM DIFF_REPORT_COUNTS c
  JOIN DIFF_REPORT_SUMMARY s
    ON c.report_id = s.report_id
 ORDER BY s.run_timestamp DESC, c.object_type;

4.5 统一趋势视图（推荐）
-- 说明：仅在 report_db_store_scope=core/full 时生成
SELECT report_id, run_timestamp, object_type,
       missing_count, unsupported_count, extra_count
  FROM DIFF_REPORT_TRENDS_V
 ORDER BY run_timestamp DESC, object_type;

----------------------------------------
5) 缺失/不支持/阻断/不一致明细（核心）
----------------------------------------
-- 缺失
SELECT source_schema, source_name, target_schema, target_name, object_type, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'MISSING'
 ORDER BY object_type, source_schema, source_name;

-- 不支持
SELECT source_schema, source_name, target_schema, target_name, object_type, status, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
 ORDER BY object_type, source_schema, source_name;

-- 阻断（UNSUPPORTED 中 status=BLOCKED）
SELECT source_schema, source_name, target_schema, target_name, object_type, reason, detail_json
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
   AND status = 'BLOCKED'
 ORDER BY object_type, source_schema, source_name;

-- 不一致（结构/约束/索引/序列/触发器等）
SELECT source_schema, source_name, target_schema, target_name, object_type, reason, detail_json
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'MISMATCHED'
 ORDER BY object_type, target_schema, target_name;

-- 明细行化（逐项查询，report_db_store_scope=full 推荐）
SELECT report_type, object_type,
       source_schema, source_name, target_schema, target_name,
       item_type, item_key, src_value, tgt_value, item_value, status
  FROM DIFF_REPORT_DETAIL_ITEM
 WHERE report_id = :report_id
 ORDER BY object_type, item_type, source_schema, source_name;

----------------------------------------
6) 依赖与阻断深挖
----------------------------------------
6.1 仅看视图依赖阻断
SELECT source_schema, source_name, reason, detail_json
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND object_type = 'VIEW'
   AND report_type = 'UNSUPPORTED'
   AND status = 'BLOCKED'
 ORDER BY source_schema, source_name;

6.2 依赖关键字过滤（依赖链通常写在 detail_json）
SELECT source_schema, object_type, source_name, report_type, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND DBMS_LOB.INSTR(detail_json, 'dependency') > 0
 ORDER BY object_type, source_schema, source_name;

6.3 依赖链明细（report_db_store_scope=full 推荐）
SELECT dep_schema, dep_name, dep_type,
       ref_schema, ref_name, ref_type,
       edge_status, reason
  FROM DIFF_REPORT_DEPENDENCY
 WHERE report_id = :report_id
 ORDER BY edge_status, dep_schema, dep_name;

6.4 VIEW 链路节点（report_db_store_scope=full 推荐）
SELECT view_schema, view_name, chain_id, node_index,
       node_schema, node_name, node_type, node_exists, grant_status, cycle_flag
  FROM DIFF_REPORT_VIEW_CHAIN
 WHERE report_id = :report_id
 ORDER BY view_schema, view_name, chain_id, node_index;

----------------------------------------
7) remap 专项
----------------------------------------
7.1 remap 影响对象总览
SELECT object_type, COUNT(*) AS cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND DBMS_LOB.INSTR(detail_json, 'remap') > 0
 GROUP BY object_type
 ORDER BY cnt DESC;

7.2 remap 影响的视图
SELECT source_schema, source_name, report_type, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND object_type = 'VIEW'
   AND DBMS_LOB.INSTR(detail_json, 'remap') > 0
 ORDER BY report_type, source_schema, source_name;

7.3 remap 冲突清单（report_db_store_scope=full 推荐）
SELECT object_type, source_schema, source_name, reason
  FROM DIFF_REPORT_REMAP_CONFLICT
 WHERE report_id = :report_id
 ORDER BY object_type, source_schema, source_name;

7.4 全量映射（report_db_store_scope=full 推荐）
SELECT object_type, src_schema, src_name, tgt_schema, tgt_name, map_source
  FROM DIFF_REPORT_OBJECT_MAPPING
 WHERE report_id = :report_id
 ORDER BY object_type, src_schema, src_name;

----------------------------------------
8) 黑名单与不支持原因
----------------------------------------
8.1 黑名单原因统计（优先用 BLACKLIST_REASON，若为空则用 REASON）
SELECT COALESCE(blacklist_reason, reason) AS blacklist_reason,
       COUNT(*) AS cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
   AND (blacklist_reason IS NOT NULL OR reason LIKE '%BLACKLIST%')
 GROUP BY COALESCE(blacklist_reason, reason)
 ORDER BY cnt DESC;

8.2 不支持原因 Top
SELECT reason, COUNT(*) AS cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
 GROUP BY reason
 ORDER BY cnt DESC;

8.3 黑名单明细（report_db_store_scope=full 推荐）
SELECT schema_name, table_name, black_type, data_type, status, reason, detail
  FROM DIFF_REPORT_BLACKLIST
 WHERE report_id = :report_id
 ORDER BY schema_name, table_name;

----------------------------------------
9) 授权差异（GRANT）
----------------------------------------
9.1 授权差异明细
SELECT target_schema, target_name, target_type,
       grantee, privilege, with_grant_option,
       status, filter_reason
  FROM DIFF_REPORT_GRANT
 WHERE report_id = :report_id
 ORDER BY status, target_schema, target_name, grantee;

9.1.1 授权分类视图
SELECT grant_class, grant_type, grantee, privilege,
       target_schema, target_name, with_grant_option
  FROM DIFF_REPORT_GRANT_CLASS_V
 WHERE report_id = :report_id
 ORDER BY grant_class, grantee, target_schema, target_name;

9.2 按 grantee 汇总
SELECT grantee,
       SUM(CASE WHEN status='MISSING' THEN 1 ELSE 0 END) AS missing_cnt,
       SUM(CASE WHEN status='EXTRA' THEN 1 ELSE 0 END) AS extra_cnt
  FROM DIFF_REPORT_GRANT
 WHERE report_id = :report_id
 GROUP BY grantee
 ORDER BY missing_cnt DESC, extra_cnt DESC;

----------------------------------------
10) 可用性 / PACKAGE / TRIGGER 状态
----------------------------------------
10.1 可用性校验明细
SELECT schema_name, object_name, object_type, usable, status, reason
  FROM DIFF_REPORT_USABILITY
 WHERE report_id = :report_id
 ORDER BY status, schema_name, object_name;

10.1.1 可用性分类视图（快速定位权限/缺对象/语法/超时）
SELECT reason_class, object_type, schema_name, object_name, reason
  FROM DIFF_REPORT_USABILITY_CLASS_V
 WHERE report_id = :report_id
   AND reason_class <> 'OK'
 ORDER BY reason_class, object_type, schema_name, object_name;

10.2 PACKAGE 对比摘要
SELECT schema_name, object_name, object_type, diff_status, diff_hash, diff_path
  FROM DIFF_REPORT_PACKAGE_COMPARE
 WHERE report_id = :report_id
 ORDER BY schema_name, object_name;

10.3 触发器状态差异
SELECT schema_name, trigger_name, src_enabled, tgt_enabled, src_valid, tgt_valid, diff_status, reason
  FROM DIFF_REPORT_TRIGGER_STATUS
 WHERE report_id = :report_id
 ORDER BY schema_name, trigger_name;

10.4 同义词专项（缺失/阻断/可用性/回溯）
-- 同义词缺失/阻断/不支持明细
SELECT report_type, status, source_schema, source_name, target_schema, target_name, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND object_type = 'SYNONYM'
 ORDER BY report_type, status, source_schema, source_name;

-- 同义词可用性结果
SELECT object_type, schema_name, object_name, status, usable, reason, detail_json
  FROM DIFF_REPORT_USABILITY
 WHERE report_id = :report_id
   AND object_type = 'SYNONYM'
   AND (status <> 'OK' OR usable IS NULL OR usable = 0)
 ORDER BY status, schema_name, object_name;

-- 可用性为 SKIPPED 时回溯原因
SELECT u.schema_name, u.object_name, u.status, u.reason,
       d.report_type, d.status AS detail_status, d.reason AS detail_reason, d.detail_json
  FROM DIFF_REPORT_USABILITY u
  LEFT JOIN DIFF_REPORT_DETAIL d
    ON d.report_id = u.report_id
   AND d.object_type = 'SYNONYM'
   AND d.source_schema = u.schema_name
   AND d.source_name = u.object_name
 WHERE u.report_id = :report_id
   AND u.object_type = 'SYNONYM'
   AND u.status <> 'OK'
 ORDER BY u.status, u.schema_name, u.object_name;

----------------------------------------
11) 高级筛选与定位
----------------------------------------
11.1 单对象全量异常
SELECT report_type, reason, detail_json
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND source_schema = :schema
   AND source_name = :object
 ORDER BY report_type;

11.2 关键字过滤（如 OBJ$ / DBLINK）
SELECT source_schema, object_type, source_name, report_type, reason
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND DBMS_LOB.INSTR(detail_json, 'OBJ$') > 0
 ORDER BY object_type, source_schema, source_name;

11.3 对象重复记录排查
SELECT source_schema, object_type, source_name, COUNT(*) AS cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
 GROUP BY source_schema, object_type, source_name
HAVING COUNT(*) > 1
 ORDER BY cnt DESC;

11.4 fixup 跳过汇总（report_db_store_scope=full 推荐）
SELECT object_type, missing_total, task_total, generated_total, skip_reason, skip_count
  FROM DIFF_REPORT_FIXUP_SKIP
 WHERE report_id = :report_id
 ORDER BY object_type, skip_reason;

11.5 OMS missing 规则映射（report_db_store_scope=full 推荐）
SELECT target_schema, object_type, src_schema, src_name, tgt_schema, tgt_name
  FROM DIFF_REPORT_OMS_MISSING
 WHERE report_id = :report_id
 ORDER BY target_schema, object_type, src_schema, src_name;

11.6 写库失败追踪（写库异常快速定位）
SELECT report_id, table_name, error_message, sql_snippet, created_at
  FROM DIFF_REPORT_WRITE_ERRORS
 WHERE report_id = :report_id
 ORDER BY created_at DESC;

11.7 标记已修复（resolution 示例）
-- INSERT INTO DIFF_REPORT_RESOLUTION
--   (REPORT_ID, OBJECT_TYPE, SCHEMA_NAME, OBJECT_NAME, ACTION_TYPE,
--    RESOLUTION_STATUS, RESOLVED_BY, RESOLVED_AT, NOTE)
-- VALUES
--   (:report_id, 'TABLE', 'SRC_SCHEMA', 'T1', 'FIXUP',
--    'RESOLVED', 'dba_user', SYSTIMESTAMP, '已修复');

----------------------------------------
12) 常见排查问答
----------------------------------------
Q1: 客户只关心“不支持”和“缺失”，怎么快速拿到？
- 使用 5) 的缺失/不支持查询，或 3) 主线步骤 2/5。

Q2: 为什么主报告里显示缺失很多，但 fixup 生成很少？
- 优先检查是否为 UNSUPPORTED/BLOCKED，或被 fixup_types/fixup_schemas 过滤。
- 使用 5) 缺失明细 + 6) 依赖阻断核对。

Q3: 视图不支持原因怎么快速聚合？
- 使用 8.2 不支持原因 Top + 7.2 remap 影响视图。

Q4: 是否能定位特定 schema 的问题？
- 用 4.3 按 schema 汇总 + 5) 过滤 source_schema。

Q5: 哪些报告未入库（需要看 TXT）？
- 查询 DIFF_REPORT_ARTIFACT，status=TXT_ONLY 或 PARTIAL。

----------------------------------------
附录 A: 按 schema + object_type 矩阵汇总
----------------------------------------
-- A.1 缺失矩阵
SELECT source_schema, object_type, COUNT(*) AS missing_cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'MISSING'
 GROUP BY source_schema, object_type
 ORDER BY source_schema, object_type;

-- A.2 不支持矩阵
SELECT source_schema, object_type, COUNT(*) AS unsupported_cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
 GROUP BY source_schema, object_type
 ORDER BY source_schema, object_type;

-- A.3 阻断矩阵（status=BLOCKED）
SELECT source_schema, object_type, COUNT(*) AS blocked_cnt
  FROM DIFF_REPORT_DETAIL
 WHERE report_id = :report_id
   AND report_type = 'UNSUPPORTED'
   AND status = 'BLOCKED'
 GROUP BY source_schema, object_type
 ORDER BY source_schema, object_type;

----------------------------------------
附录 B: 按时间窗口统计
----------------------------------------
-- B.1 最近 N 天按对象类型汇总（例：近 7 天）
SELECT c.object_type,
       SUM(c.missing_count) AS missing_cnt,
       SUM(c.unsupported_count) AS unsupported_cnt,
       SUM(c.extra_count) AS extra_cnt
  FROM DIFF_REPORT_COUNTS c
  JOIN DIFF_REPORT_SUMMARY s
    ON c.report_id = s.report_id
 WHERE s.run_timestamp >= SYSTIMESTAMP - INTERVAL '7' DAY
 GROUP BY c.object_type
 ORDER BY unsupported_cnt DESC, missing_cnt DESC;

-- B.2 最近 N 天按 schema 汇总（例：近 7 天）
SELECT COALESCE(d.source_schema, d.target_schema) AS schema_name,
       SUM(CASE WHEN d.report_type='MISSING' THEN 1 ELSE 0 END) AS missing_cnt,
       SUM(CASE WHEN d.report_type='UNSUPPORTED' THEN 1 ELSE 0 END) AS unsupported_cnt
  FROM DIFF_REPORT_DETAIL d
  JOIN DIFF_REPORT_SUMMARY s
    ON d.report_id = s.report_id
 WHERE s.run_timestamp >= SYSTIMESTAMP - INTERVAL '7' DAY
 GROUP BY COALESCE(d.source_schema, d.target_schema)
 ORDER BY unsupported_cnt DESC, missing_cnt DESC;

-- B.3 按日统计缺失数量趋势
SELECT TRUNC(s.run_timestamp) AS run_day,
       SUM(s.missing_count) AS missing_cnt,
       SUM(s.unsupported_count) AS unsupported_cnt
  FROM DIFF_REPORT_SUMMARY s
 GROUP BY TRUNC(s.run_timestamp)
 ORDER BY run_day DESC;

----------------------------------------
附录 C: 概况型 SQL（线/面视角）
----------------------------------------
C.1 整体体检总览（单条 SQL）
SELECT
  s.report_id,
  s.run_timestamp,
  s.conclusion,
  s.total_checked,
  s.missing_count,
  s.mismatched_count,
  s.unsupported_count,
  (SELECT COUNT(*) FROM DIFF_REPORT_DETAIL d
     WHERE d.report_id = s.report_id
       AND d.report_type = 'UNSUPPORTED'
       AND d.status = 'BLOCKED') AS blocked_count,
  (SELECT COUNT(*) FROM DIFF_REPORT_DETAIL d
     WHERE d.report_id = s.report_id
       AND d.report_type = 'MISSING') AS missing_detail_count,
  (SELECT COUNT(*) FROM DIFF_REPORT_DETAIL d
     WHERE d.report_id = s.report_id
       AND d.report_type = 'UNSUPPORTED') AS unsupported_detail_count
FROM DIFF_REPORT_SUMMARY s
WHERE s.report_id = :report_id;

C.2 面板式汇总（按类型 + 状态）
SELECT object_type,
       SUM(CASE WHEN report_type='MISSING' THEN 1 ELSE 0 END) AS missing_cnt,
       SUM(CASE WHEN report_type='MISMATCHED' THEN 1 ELSE 0 END) AS mismatched_cnt,
       SUM(CASE WHEN report_type='UNSUPPORTED' THEN 1 ELSE 0 END) AS unsupported_cnt,
       SUM(CASE WHEN report_type='UNSUPPORTED' AND status='BLOCKED' THEN 1 ELSE 0 END) AS blocked_cnt
FROM DIFF_REPORT_DETAIL
WHERE report_id = :report_id
GROUP BY object_type
ORDER BY unsupported_cnt DESC, missing_cnt DESC;

C.3 迁移重点面板（按 schema：需改造 vs 可修复）
SELECT COALESCE(source_schema, target_schema) AS schema_name,
       SUM(CASE WHEN report_type='UNSUPPORTED' THEN 1 ELSE 0 END) AS need_rebuild,
       SUM(CASE WHEN report_type='MISSING' THEN 1 ELSE 0 END) AS can_fixup
FROM DIFF_REPORT_DETAIL
WHERE report_id = :report_id
GROUP BY COALESCE(source_schema, target_schema)
ORDER BY need_rebuild DESC, can_fixup DESC;

C.4 原因热力图（按原因聚合）
SELECT object_type, reason, COUNT(*) AS cnt
FROM DIFF_REPORT_DETAIL
WHERE report_id = :report_id
  AND report_type IN ('UNSUPPORTED','MISMATCHED')
GROUP BY object_type, reason
ORDER BY cnt DESC;

----------------------------------------
附录 D: DB 覆盖范围 vs 文本文件
----------------------------------------
说明：report_to_db 只入库结构化核心数据，部分细节仍在 run 目录的 txt 中。

D.1 直接在 OB 查询即可的内容
- 缺失/不支持/阻断/不一致明细：DIFF_REPORT_DETAIL
- 触发器状态差异：DIFF_REPORT_TRIGGER_STATUS
- PACKAGE/PKG BODY 对比摘要：DIFF_REPORT_PACKAGE_COMPARE
- 可用性校验明细：DIFF_REPORT_USABILITY
- 汇总与趋势：DIFF_REPORT_SUMMARY / DIFF_REPORT_COUNTS
- 授权差异：DIFF_REPORT_GRANT

D.2 仍需查看 txt 的内容（仅文本）
- report_<ts>.txt（主报告全文）
- report_index_<ts>.txt（明细索引）
- object_mapping_<ts>.txt / remap_conflicts_<ts>.txt
- dependency_chains_<ts>.txt / VIEWs_chain_<ts>.txt
- ddl_format_report_<ts>.txt / ddl_punct_clean_<ts>.txt / ddl_hint_clean_<ts>.txt
- migration_focus_<ts>.txt / blacklist_tables.txt / filtered_grants.txt
- missed_tables_views_for_OMS/*

D.3 快速定位对应 run 目录
SELECT report_id, run_timestamp, run_dir
  FROM DIFF_REPORT_SUMMARY
 WHERE report_id = :report_id;

D.4 建议流程
- 先看 OB 汇总与明细（DIFF_REPORT_*）
- 如发现关键差异，需要深挖，再到 run_dir 对应 txt 查“链路/索引/清洗/格式化”等细节
