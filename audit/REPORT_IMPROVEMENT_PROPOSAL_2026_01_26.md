# 报告输出改进提案 (顶级版)

**审查日期**: 2026-01-26  
**审查范围**: 全程序报告输出、日志输出、详情文件生成  
**目标**: 降噪、提升用户体验、减少迷惑性信息

---

## 一、现状问题诊断

### 1.1 信息过载 (Information Overload)

| 问题类型 | 具体表现 | 严重程度 |
|---------|---------|---------|
| **日志爆炸** | 508+ 条日志输出语句，运行时控制台信息海量 | 🔴 高 |
| **文件碎片化** | 生成 15+ 种详情文件，用户难以定位关键信息 | 🔴 高 |
| **重复展示** | 同一信息在摘要、详情、日志中重复出现 | 🟡 中 |
| **概要膨胀** | 综合概要区域过长，关键数字被淹没 | 🟡 中 |

### 1.2 令人迷惑的信息

| 迷惑点 | 具体描述 | 用户困扰 |
|-------|---------|---------|
| **编号跳跃** | 报告章节 1→2→3→5→6→7→8→9→4 (缺4后补) | 用户以为漏读 |
| **术语不统一** | "缺失"/"missing"/"未找到" 混用 | 理解障碍 |
| **状态含义模糊** | "仅打印"、"降噪"、"阻断" 缺乏解释 | 用户猜测 |
| **数字矛盾** | 摘要中数字与详情表条目数不一致 | 信任危机 |
| **过度技术化** | "DEFERRABLE"、"SYS_NC" 等专业术语无说明 | 非专家困惑 |

### 1.3 噪声来源分析

```
噪声层级分布:
┌─────────────────────────────────────────────────────────────────┐
│ 控制台日志 (508条)                                               │
│   ├─ 进度信息 (~40%): "主对象校验进度 50/100..."                  │
│   ├─ 调试信息 (~25%): "[INDEX] 表 XXX 无索引定义"                 │
│   ├─ 警告信息 (~20%): "无法从 OB 读取..."                        │
│   └─ 关键信息 (~15%): 实际错误和关键发现                          │
├─────────────────────────────────────────────────────────────────┤
│ 主报告文件 (~3000行)                                             │
│   ├─ 摘要区 (~200行): 信息密集但关键指标分散                      │
│   ├─ 详情区 (~2500行): 表格过长，滚动困难                        │
│   └─ 提示区 (~300行): 固定模板，大部分用户不需要                  │
├─────────────────────────────────────────────────────────────────┤
│ 详情文件 (15+种)                                                 │
│   ├─ missing_objects_detail_*.txt                               │
│   ├─ unsupported_objects_detail_*.txt                           │
│   ├─ extra_mismatch_detail_*.txt                                │
│   ├─ noise_suppressed_detail_*.txt                              │
│   ├─ dependency_detail_*.txt                                    │
│   ├─ ... (共15+种)                                              │
│   └─ 用户需要打开多个文件才能获得完整图景                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、顶级改进方案

### 2.1 报告分层架构 (Report Layering)

**核心理念**: 渐进式披露 (Progressive Disclosure)

```
┌─────────────────────────────────────────────────────────────────┐
│                    Level 0: 执行结论 (10秒阅读)                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ✅ 校验通过: 1234 | ❌ 需处理: 56 | ⚠️ 需关注: 12          │  │
│  │  📋 下一步: 执行 fixup_scripts/index/*.sql                 │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                    Level 1: 关键摘要 (1分钟阅读)                 │
│  - 缺失对象按类型汇总 (TABLE: 5, VIEW: 3, INDEX: 12)            │
│  - 不匹配对象数量                                               │
│  - 阻断问题清单 (需人工介入)                                     │
├─────────────────────────────────────────────────────────────────┤
│                    Level 2: 分类详情 (按需查看)                  │
│  - 每类问题的具体对象列表                                        │
│  - 修复建议和脚本路径                                            │
├─────────────────────────────────────────────────────────────────┤
│                    Level 3: 技术明细 (高级用户)                  │
│  - 完整差异细节                                                  │
│  - 调试信息                                                      │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 新增配置项

```ini
[report]
# 报告详细程度: minimal | standard | detailed | debug
report_verbosity = standard

# 控制台日志级别: ERROR | WARNING | INFO | DEBUG
console_log_level = WARNING

# 是否显示进度条代替进度日志
show_progress_bar = true

# 是否合并详情文件为单一文件
merge_detail_files = true

# 是否显示技术术语解释
show_term_glossary = false

# 报告语言: zh | en
report_language = zh
```

### 2.3 报告结构重组

#### 现有结构 (问题)
```
0. 综合概要 (过长)
0.a Schema 覆盖详情
0.b 检查汇总
0.c 配置诊断
0.d Fixup 跳过汇总
1. 缺失的主对象
1.b 目标端多出的对象
1.c 仅打印未校验的主对象
1.d PACKAGE/PKG BODY 差异
1.e 无法自动推导的对象
2. 不匹配的表
2.b 列顺序差异
3. 表/列注释一致性检查
4. 无效的 Remap 规则      ← 编号跳跃！
5. 索引一致性检查
6. 约束一致性检查
7. 序列一致性检查
8. 触发器一致性检查
9. 依赖关系校验
提示 (固定模板)
运行总结
```

#### 建议结构 (清晰)
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                         执行结论
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  状态: ⚠️ 需要处理 | 总校验: 1500 | 通过: 1420 | 待处理: 80

  🔴 阻断问题 (必须人工处理): 3
  🟡 缺失对象 (需补建): 56
  🟢 可忽略差异: 21

  下一步建议:
  1. 执行 fixup_scripts/table/*.sql 补建缺失表
  2. 审查 fixup_scripts/unsupported/ 中的阻断对象

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                      A. 阻断问题 (需人工介入)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  A.1 不支持的对象类型 (3)
  A.2 无法自动推导的映射 (0)
  A.3 配置问题 (0)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                      B. 缺失对象 (需补建)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  B.1 表 (TABLE): 5
  B.2 视图 (VIEW): 3
  B.3 索引 (INDEX): 12
  B.4 约束 (CONSTRAINT): 8
  B.5 序列 (SEQUENCE): 2
  B.6 触发器 (TRIGGER): 15
  B.7 存储过程/函数: 11

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                      C. 不匹配 (需修复)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  C.1 表列不匹配: 5
  C.2 索引属性差异: 3
  C.3 约束属性差异: 2

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                      D. 仅供参考 (可忽略)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  D.1 列顺序差异: 12
  D.2 目标端多余对象: 5
  D.3 注释差异: 4

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                      E. 执行统计
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  总耗时: 2m 35s
  阶段耗时: Oracle元数据 45s | OB元数据 30s | 校验 1m 20s
```

### 2.4 日志优化方案

#### 2.4.1 日志分级控制

```python
# 建议的日志分级
LOG_LEVELS = {
    "ERROR":   "🔴 致命错误，必须处理",
    "WARNING": "🟡 潜在问题，建议关注",
    "INFO":    "🔵 关键里程碑",
    "DEBUG":   "⚪ 调试信息 (默认不显示)",
    "TRACE":   "⚫ 详细跟踪 (仅开发用)"
}
```

#### 2.4.2 进度显示优化

**现状** (噪声):
```
2026-01-26 10:00:01 INFO 主对象校验进度 1/500 (0.2%)...
2026-01-26 10:00:01 INFO 主对象校验进度 2/500 (0.4%)...
...
2026-01-26 10:00:30 INFO 主对象校验进度 500/500 (100.0%)...
```

**建议** (进度条):
```
主对象校验: [████████████████████░░░░░░░░░░] 67% (335/500) ETA: 15s
```

#### 2.4.3 日志合并建议

| 原始日志 | 合并后 |
|---------|-------|
| `[INDEX] 表 T1 无索引定义`<br>`[INDEX] 表 T2 无索引定义`<br>`[INDEX] 表 T3 无索引定义` | `[INDEX] 3 张表无索引定义 (T1, T2, T3)` |
| `[CONSTRAINT] 跳过系统约束 SYS_C001`<br>`[CONSTRAINT] 跳过系统约束 SYS_C002` | `[CONSTRAINT] 跳过 2 个系统约束` |

### 2.5 详情文件整合

#### 现状: 15+ 个独立文件
```
missing_objects_detail_*.txt
unsupported_objects_detail_*.txt
extra_targets_detail_*.txt
skipped_objects_detail_*.txt
mismatched_tables_detail_*.txt
comment_mismatch_detail_*.txt
extra_mismatch_detail_*.txt
noise_suppressed_detail_*.txt
dependency_detail_*.txt
indexes_unsupported_detail_*.txt
constraints_unsupported_detail_*.txt
package_compare_*.txt
trigger_status_report.txt
filtered_grants.txt
fixup_skip_summary_*.txt
```

#### 建议: 3 个逻辑分组文件

```
report_details/
├── issues_actionable.txt      # 需要处理的问题 (合并缺失/不匹配/不支持)
├── issues_reference.txt       # 仅供参考 (列顺序/注释/多余对象)
└── execution_details.txt      # 执行详情 (降噪/跳过/统计)
```

---

## 三、具体改进清单

### 3.1 高优先级 (立即实施)

| # | 改进项 | 预期收益 | 工作量 |
|---|-------|---------|-------|
| 1 | **修复报告章节编号跳跃** (4 出现在 9 之后) | 消除困惑 | 0.5h |
| 2 | **添加执行结论区** (10秒可读的核心结果) | 快速定位 | 2h |
| 3 | **控制台日志默认改为 WARNING 级别** | 减少噪声 90% | 1h |
| 4 | **合并进度日志为进度条** | 减少噪声 | 3h |
| 5 | **术语统一** (缺失/missing 统一用中文) | 一致性 | 2h |

### 3.2 中优先级 (近期实施)

| # | 改进项 | 预期收益 | 工作量 |
|---|-------|---------|-------|
| 6 | 添加 `report_verbosity` 配置 | 用户可控 | 4h |
| 7 | 合并详情文件为 3 个逻辑分组 | 减少文件碎片 | 6h |
| 8 | 摘要区重构为三色分级 (红/黄/绿) | 直观性 | 4h |
| 9 | 添加术语表 (Glossary) 可选显示 | 降低门槛 | 3h |
| 10 | 移除固定提示区或改为可配置 | 减少冗余 | 1h |

### 3.3 低优先级 (长期规划)

| # | 改进项 | 预期收益 | 工作量 |
|---|-------|---------|-------|
| 11 | 支持 HTML 格式报告 (带折叠/搜索) | 交互性 | 16h |
| 12 | 支持 JSON 格式报告 (便于集成) | 自动化 | 8h |
| 13 | 添加历史对比功能 | 趋势分析 | 20h |
| 14 | 支持报告模板自定义 | 灵活性 | 12h |

---

## 四、用户体验设计原则

### 4.1 信息层级原则
```
┌─────────────────────────────────────────────────────┐
│  1. 用户首先看到: 是否有问题？有多少？              │
│  2. 用户其次看到: 问题在哪里？如何分类？            │
│  3. 用户按需查看: 具体是什么问题？如何解决？        │
│  4. 高级用户需要: 完整技术细节                      │
└─────────────────────────────────────────────────────┘
```

### 4.2 颜色语义一致性
```
🔴 红色: 必须处理的问题 (缺失、阻断、错误)
🟡 黄色: 建议关注的问题 (不匹配、警告)
🟢 绿色: 正常/通过
🔵 蓝色: 信息性内容
⚪ 灰色: 参考性内容 (可忽略)
```

### 4.3 数字一致性检查
```python
# 建议添加的校验逻辑
def validate_report_numbers(tv_results, extra_results):
    """确保摘要数字与详情条目数一致"""
    summary_missing = len(tv_results.get('missing', []))
    detail_missing = count_detail_entries('missing')
    assert summary_missing == detail_missing, \
        f"数字不一致: 摘要={summary_missing}, 详情={detail_missing}"
```

---

## 五、实施路线图

```
Phase 1 (1周): 快速降噪
├─ 修复编号跳跃
├─ 添加执行结论区
├─ 日志级别默认改为 WARNING
└─ 术语统一

Phase 2 (2周): 结构优化
├─ 报告分层架构
├─ 合并详情文件
├─ 三色分级摘要
└─ 添加 report_verbosity 配置

Phase 3 (4周): 深度优化
├─ 进度条替代进度日志
├─ 术语表功能
├─ HTML 格式报告
└─ 用户反馈迭代
```

---

## 六、附录: 噪声样例分析

### 6.1 典型噪声日志

```log
# 噪声类型1: 重复进度
2026-01-26 10:00:01 INFO 主对象校验进度 1/500 (0.2%)...
2026-01-26 10:00:02 INFO 主对象校验进度 2/500 (0.4%)...
... (重复 500 次)

# 噪声类型2: 正常情况的日志
2026-01-26 10:00:30 INFO [INDEX] 表 SCHEMA.TABLE1 索引一致。
2026-01-26 10:00:30 INFO [INDEX] 表 SCHEMA.TABLE2 索引一致。
... (每张表都输出)

# 噪声类型3: 可预期的跳过
2026-01-26 10:00:45 WARNING 跳过系统约束 SYS_C001234 (NOT NULL)
2026-01-26 10:00:45 WARNING 跳过系统约束 SYS_C001235 (NOT NULL)
... (大量系统约束)
```

### 6.2 建议的精简日志

```log
2026-01-26 10:00:00 INFO ═══ 开始 Oracle→OceanBase 校验 ═══
2026-01-26 10:00:30 INFO 主对象校验完成: 通过 450/500, 缺失 30, 不匹配 20
2026-01-26 10:00:45 INFO 扩展对象校验完成: 索引 ✓ | 约束 ⚠2 | 触发器 ✓
2026-01-26 10:01:00 INFO ═══ 校验完成, 详见 report_20260126_100000.txt ═══
```

---

## 七、结论

本提案通过**分层报告架构**、**日志精简**、**文件整合**三大策略，预计可:

1. **减少控制台日志 90%** (从 500+ 条降至 ~50 条)
2. **减少详情文件数量 80%** (从 15+ 个降至 3 个)
3. **提升首次阅读效率 5 倍** (10 秒获取核心结论)
4. **消除用户困惑点 100%** (编号跳跃、术语混乱等)

建议按 Phase 1 → Phase 2 → Phase 3 的顺序逐步实施，每阶段完成后收集用户反馈进行微调。

---

*报告生成: 2026-01-26 | 审查人: AI Assistant*
