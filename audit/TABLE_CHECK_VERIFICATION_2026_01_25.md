# 表对象检查验证报告

**验证日期**: 2026-01-25  
**验证人**: Codex  
**目标版本**: schema_diff_reconciler.py (V0.9.8)  
**验证范围**: `audit/TABLE_CHECK_SPECIFICATION.md` 全量条目  
**验证方式**: 真实 Oracle + OceanBase 连接、真实 DDL、真实比较输出  

---

## 1. 执行环境与证据

**运行脚本**: `audit/table_check_validation/run_validation.py`  
**运行目录**: `audit/table_check_validation/run_20260125_121917`  
**配置快照**: `audit/table_check_validation/run_20260125_121917/config.ini`  
**核心报告**: `audit/table_check_validation/run_20260125_121917/reports/run_20260125_121946/report_20260125_121946.txt`  
**表列不匹配**: `audit/table_check_validation/run_20260125_121917/reports/run_20260125_121946/mismatched_tables_detail_20260125_121946.txt`  
**扩展对象差异**: `audit/table_check_validation/run_20260125_121917/reports/run_20260125_121946/extra_mismatch_detail_20260125_121946.txt`  
**约束不支持**: `audit/table_check_validation/run_20260125_121917/reports/run_20260125_121946/constraints_unsupported_detail_20260125_121946.txt`  
**注释差异**: `audit/table_check_validation/run_20260125_121917/reports/run_20260125_121946/comment_mismatch_detail_20260125_121946.txt`  
**调试日志**: `audit/table_check_validation/run_20260125_121917/logs/run_20260125_121946.log`  
**Oracle 元数据**: `audit/table_check_validation/run_20260125_121917/queries/oracle_metadata.txt`  
**OB 元数据**: `audit/table_check_validation/run_20260125_121917/queries/ob_metadata.txt`

**数据库版本** (来自主报告):
- Oracle: 19.3.0.0.0 (PDB ORA19PDB1)
- OceanBase: 4.2.5.7 (Oracle 模式)

---

## 2. 目标端功能支持探测

实际元数据字段支持（从 `DBA_TAB_COLUMNS` / `DBA_CONSTRAINTS` 检查）：

- **OceanBase**
  - `DBA_TAB_COLUMNS`: 存在 `IDENTITY_COLUMN`, `DEFAULT_ON_NULL`，缺少 `VIRTUAL_COLUMN`, `INVISIBLE_COLUMN`
  - `DBA_CONSTRAINTS`: 存在 `DEFERRABLE`, `DEFERRED`, `INDEX_NAME`；不支持 `SEARCH_CONDITION_VC`
  - 结论：IDENTITY/DEFAULT ON NULL 字段存在但填充值为 NULL（见 `ob_metadata.txt`），VIRTUAL/INVISIBLE 元数据缺失

- **Oracle**
  - `DBA_TAB_COLUMNS`: 本环境未暴露 `VIRTUAL_COLUMN`, `INVISIBLE_COLUMN` 字段（动态探测后未纳入查询）
  - 结论：虚拟列/不可见列无法通过元数据字段直接验证

---

## 3. 测试矩阵（按规格逐条覆盖）

> 说明：每条用例包含 Oracle/OB 实际 DDL（关键片段）、预期结果、实际结果与证据路径。

### 3.1 列结构检查

**TC-COL-001 NUMBER(*,0) 等价 NUMBER(38,0)**  
- Oracle: `TCHK_COL_EQ.C_NUM_STAR NUMBER(*,0)`  
- OB: `TCHK_COL_EQ.C_NUM_STAR NUMBER(38,0)`  
- 预期: 等价，不应报错  
- 实际: 未出现在 `mismatched_tables_detail` 的 TYPE_MISMATCHES  
- 证据: `audit/table_check_validation/run_20260125_121917/queries/oracle_metadata.txt`, `audit/table_check_validation/run_20260125_121917/queries/ob_metadata.txt`

**TC-COL-002 NUMBER 精度放大等价**  
- Oracle: `TCHK_COL_EQ.C_NUM_WIDE NUMBER(10,2)`  
- OB: `TCHK_COL_EQ.C_NUM_WIDE NUMBER(12,2)`  
- 预期: 等价（目标精度更大）  
- 实际: 未报错  
- 证据: 同上

**TC-COL-003 VARCHAR2 BYTE 1.5x 长度规则**  
- Oracle: `TCHK_COL_EQ.C_VC_BYTE VARCHAR2(10 BYTE)`  
- OB: `TCHK_COL_EQ.C_VC_BYTE VARCHAR2(15 BYTE)`  
- 预期: 长度满足 `ceil(10*1.5)=15`，应一致  
- 实际: 未报错  
- 证据: `mismatched_tables_detail_20260125_121946.txt`

**TC-COL-004 VARCHAR2 CHAR 语义精确匹配**  
- Oracle: `TCHK_COL_EQ.C_VC_CHAR VARCHAR2(8 CHAR)`  
- OB: `TCHK_COL_EQ.C_VC_CHAR VARCHAR2(8 CHAR)`  
- 预期: 一致  
- 实际: 未报错  
- 证据: `oracle_metadata.txt`, `ob_metadata.txt`

**TC-COL-005 DEFAULT ON NULL**  
- Oracle: `TCHK_COL_EQ.C_DEF_ON_NULL NUMBER DEFAULT ON NULL 5`  
- OB: 不支持 DEFAULT ON NULL（回退为 `DEFAULT 5`）  
- 预期: 目标缺失应报错  
- 实际: 报错 `default_on_null_missing`  
- 证据: `mismatched_tables_detail_20260125_121946.txt`

**TC-COL-006 IDENTITY 列**  
- Oracle: `TCHK_COL_EQ.ID GENERATED BY DEFAULT AS IDENTITY`  
- OB: 语法接受，但 `IDENTITY_COLUMN` 元数据为空  
- 预期: 元数据缺失应报错  
- 实际: 报错 `identity_missing`  
- 证据: `mismatched_tables_detail_20260125_121946.txt`, `ob_metadata.txt`

**TC-COL-007 NUMBER 无界 vs 有界**  
- Oracle: `TCHK_COL_UNBOUNDED_OK.C_NUM NUMBER`  
- OB: `NUMBER`  
- 预期: 等价  
- 实际: 未报错  

**TC-COL-008 NUMBER 无界 vs NUMBER(38,0) 不等价**  
- Oracle: `TCHK_COL_UNBOUNDED_BAD.C_NUM NUMBER`  
- OB: `NUMBER(38,0)`  
- 预期: 不等价  
- 实际: 报错 `number_precision`  
- 证据: `mismatched_tables_detail_20260125_121946.txt`

**TC-COL-009 LONG/LONG RAW 映射**  
- Oracle: `TCHK_COL_LONG.C_LONG LONG`, `TCHK_COL_LONG_RAW.C_LONG_RAW LONG RAW`  
- OB: `CLOB` / `BLOB`  
- 预期: 允许映射  
- 实际: 对应表未出现在 mismatched 列表  
- 证据: `mismatched_tables_detail_20260125_121946.txt`

**TC-COL-010 缺失列/多余列**  
- Oracle-only: `TCHK_COL_MISMATCH.C_MISSING_OB`  
- OB-only: `TCHK_COL_MISMATCH.C_EXTRA_OB`  
- 预期: 记录缺失/多余  
- 实际: `MISSING_COLS=C_MISSING_OB`, `EXTRA_COLS=C_EXTRA_OB`  
- 证据: `mismatched_tables_detail_20260125_121946.txt`

**TC-COL-011 VARCHAR2 BYTE 过短/过大**  
- Oracle: `C_VC_SHORT VARCHAR2(10 BYTE)` / `C_VC_OVER VARCHAR2(10 BYTE)`  
- OB: `VARCHAR2(14 BYTE)` / `VARCHAR2(26 BYTE)`  
- 预期: `short` 与 `oversize`  
- 实际: 与预期一致  
- 证据: `mismatched_tables_detail_20260125_121946.txt`

**TC-COL-012 虚拟列表达式**  
- Oracle: `TCHK_COL_VIRTUAL.VIRT_VAL GENERATED ALWAYS AS (BASE_VAL * 2)`  
- OB: 同语法创建成功  
- 预期: 若元数据支持，应验证表达式一致  
- 实际: Oracle/OB 均缺 `VIRTUAL_COLUMN` 元字段，比较逻辑未触发；该项无法验证  
- 证据: `oracle_metadata.txt`, `ob_metadata.txt`（无 VIRTUAL_COLUMN 字段）

**TC-COL-013 INVISIBLE 列**  
- Oracle: `TCHK_COL_INVISIBLE.INVIS_COL INVISIBLE`  
- OB: 语法创建成功  
- 预期: 若元数据支持，应验证可见性  
- 实际: Oracle/OB 均缺 `INVISIBLE_COLUMN` 元字段，比较逻辑未触发；该项无法验证  
- 证据: `oracle_metadata.txt`, `ob_metadata.txt`

---

### 3.2 索引检查

**TC-IDX-001 索引列集匹配（忽略索引名）**  
- Oracle: `IDX_COL_NN(VAL2)`  
- OB: `UK_VAL2` (UNIQUE)  
- 预期: 列集匹配，允许唯一性差异（有约束支撑）  
- 实际: 索引差异为 0；调试日志显示匹配  
- 证据: `run_20260125_121946.log` 中 `VAL2` 相关 DEBUG 行

**TC-IDX-002 函数索引表达式 + SYS_NC 归一化**  
- Oracle: `IDX_EXPR_NN` on `UPPER(VAL)` (NONUNIQUE)  
- OB: `IDX_EXPR_U` on `UPPER(VAL)` (UNIQUE, SYS_NC 列)  
- 预期: 表达式大小写归一 + SYS_NC 归一后视为一致  
- 实际: 索引差异为 0  
- 证据: `ob_metadata.txt` 的 `DBA_IND_EXPRESSIONS` 记录 `UPPER("VAL")`

**TC-IDX-003 非唯一→唯一的约束支撑**  
- Oracle: `IDX_EXPR_NN` (NONUNIQUE)  
- OB: `IDX_EXPR_U` (UNIQUE) 且存在约束 `IDX_EXPR_U` (U) + INDEX_NAME 指向索引  
- 预期: 通过约束支撑消除唯一性差异  
- 实际: DEBUG 日志确认识别约束支撑  
- 证据: `audit/table_check_validation/run_20260125_121917/logs/run_20260125_121946.log`  
  - `索引列 ['UPPER(VAL)']: 源端NONUNIQUE变目标端UNIQUE，有约束支撑，视为正常迁移`

---

### 3.3 约束检查

**TC-CONS-001 CHECK 表达式大小写/括号归一**  
- Oracle: `CK_STATUS CHECK (STATUS IN ('A','B'))`  
- OB: `CK_STATUS CHECK (status in ('A','B'))`  
- 预期: 等价  
- 实际: 无差异记录  
- 证据: `extra_mismatch_detail_20260125_121946.txt` 未包含 CK_STATUS

**TC-CONS-002 CHECK DEFERRABLE 不支持**  
- Oracle: `CK_FLAG_DEF ... DEFERRABLE INITIALLY IMMEDIATE`  
- OB: 不支持 DEFERRABLE（回退为非 DEFERRABLE）  
- 预期: 记录为不支持或差异  
- 实际: 记录为不支持 + extra  
- 证据: `constraints_unsupported_detail_20260125_121946.txt`

**TC-CONS-003 FOREIGN KEY 删除规则一致/不一致**  
- Oracle `FK_CHILD_OK`: CASCADE；OB 同 CASCADE → 一致  
- Oracle `FK_CHILD_BAD`: CASCADE；OB SET NULL → 不一致  
- 实际: 仅 FK_CHILD_BAD 报错  
- 证据: `extra_mismatch_detail_20260125_121946.txt`

**TC-CONS-004 PK 分区键降级匹配**  
- Oracle: `TCHK_PK_PART` 为分区表，PK 不含分区键  
- OB: 非分区表，PK 仅 ID  
- 预期: PK 允许降级匹配，视为一致  
- 实际: 未出现该表约束差异  
- 证据: `extra_mismatch_detail_20260125_121946.txt`

**TC-CONS-005 系统 NOT NULL 约束过滤**  
- OB 自动生成 `*_OBNOTNULL_*` 约束存在于 DBA_CONSTRAINTS  
- 预期: 被过滤不产生差异  
- 实际: 未作为约束差异输出  
- 证据: `ob_metadata.txt` 中 OBNOTNULL 记录，`extra_mismatch_detail` 无对应条目

---

### 3.4 触发器检查

**TC-TRG-001 触发器存在性/事件一致**  
- Oracle/OB: `TRG_TRG_OK` BEFORE INSERT  
- 预期: 一致  
- 实际: 无差异  

**TC-TRG-002 启用状态差异**  
- Oracle: `TRG_TRG_BAD` ENABLED  
- OB: `TRG_TRG_BAD` DISABLED  
- 预期: 报启用状态差异  
- 实际: 报错 `启用状态不一致`  
- 证据: `extra_mismatch_detail_20260125_121946.txt`

---

### 3.5 注释检查

**TC-CMT-001 表/列注释一致与不一致**  
- 表注释一致：`TCHK_COMMENT`  
- 列注释差异：`TCHK_COMMENT.C2`  
- 实际: 报告 `C2: Column C2 Oracle -> Column C2 OB`  
- 证据: `comment_mismatch_detail_20260125_121946.txt`

**TC-CMT-002 OB 自动列导致的注释差异**  
- OB 自动列：`__PK_INCREMENT`, `SYS_NC19$`  
- 实际: 多个表被记录为 `EXTRA_COLS`  
- 结论: 注释检查对自动列敏感，属于环境差异  
- 证据: `comment_mismatch_detail_20260125_121946.txt`

**TC-CMT-003 过滤自动列后的注释一致性结论**  
- 过滤规则: 注释差异统计时忽略 `EXTRA_COLS/MISSING_COLS` 中的 `__PK_INCREMENT` 与 `SYS_NC19$`  
- 原始注释差异: 13 条  
- 仅由自动列导致的差异: 10 条（可忽略）  
- 过滤后仍保留的差异: 3 条  
  - `TCHK.TCHK_COL_MISMATCH`：存在真实缺失/多余列（`C_MISSING_OB`/`C_EXTRA_OB`）  
  - `TCHK.TCHK_COMMENT`：列注释差异 `C2: Column C2 Oracle -> Column C2 OB`  
  - `TCHK.TCHK_ONLY_ORA`：源端表缺失列导致注释缺失  
- 证据: `comment_mismatch_detail_20260125_121946.txt`

---

### 3.6 序列检查

**TC-SEQ-001 SEQ_OK 属性一致**  
- Oracle/OB: `SEQ_OK`  
- 预期: 一致  
- 实际: 未报错  

**TC-SEQ-002 SEQ_BAD 增量差异**  
- Oracle: INCREMENT_BY=1  
- OB: INCREMENT_BY=2  
- 预期: 报差异  
- 实际: 报错 `INCREMENT_BY: 1->2`  
- 证据: `extra_mismatch_detail_20260125_121946.txt`

**附加观察**: Identity 自动序列 `ISEQ$$_*` 在 Oracle/OB 名称不同，序列比较会报告缺失/多余。该行为符合当前实现（未过滤）。

---

## 4. 关键结论

1. **等价性规则**（NUMBER(*)、NUMBER 精度放大、表达式索引大小写/ SYS_NC 归一）在本次实测中均能正确判定为一致。
2. **Oracle/OB 元数据缺失**导致的不可验证项：`VIRTUAL_COLUMN`、`INVISIBLE_COLUMN` 目前无法通过 DBA_TAB_COLUMNS 验证，实际比较逻辑未触发。
3. **OceanBase 语法差异**：`DEFAULT ON NULL`、`DEFERRABLE` CHECK 不支持，产生明确差异/不支持记录。
4. **注释比较**对 OB 自动列敏感；过滤 `__PK_INCREMENT` / `SYS_NC19$` 后注释差异从 13 降至 3，建议在注释差异统计中忽略自动列。

---

## 5. 可复现实验步骤

1. 使用 `audit/table_check_validation/run_validation.py` 自动执行：
   - 自动重建 TCHK 用户
   - 创建 Oracle/OB 对应对象
   - 抽取元数据与运行 comparator
2. 观察输出目录：`audit/table_check_validation/run_20260125_121917/`
3. 重点关注：
   - `mismatched_tables_detail_20260125_121946.txt`
   - `extra_mismatch_detail_20260125_121946.txt`
   - `constraints_unsupported_detail_20260125_121946.txt`
   - `comment_mismatch_detail_20260125_121946.txt`

---

## 6. 待确认问题

- 是否需要对 IDENTITY 自动序列做过滤（避免 `ISEQ$$_*` 差异噪声）？
- 是否需要增强虚拟列 / 不可见列的元数据获取（若 DB 版本支持）？

---

*报告生成时间: 2026-01-25 12:20*

---

## 7. 补充验证 (2026-01-25 18:09)

- 补充报告: `main_reports/run_20260125_180907/report_20260125_180907.txt`
- VIRTUAL/INVISIBLE 元数据: 通过 DBA_TAB_COLS 自动切换可读取，虚拟列对比实际生效
- 虚拟表达式空白归一: `BASE_COL+1` 与 `BASE_COL + 1` 视为一致，虚拟列误报已消除
- 自动序列 ISEQ$$_*: 已纳入降噪，不再进入差异/修补脚本
- 最终结果: 主对象/扩展对象/注释/依赖差异均为 0，仅保留降噪项与 remap 无效提示
