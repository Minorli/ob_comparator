# init_test.py 代码审查报告

**审查日期**: 2026-01-28
**审查范围**: 未使用对象、重复代码、安全、缺陷、代码质量
**文件**: init_test.py

---

## 1. 未使用对象

**无发现** - 所有函数和常量均被使用。

---

## 2. 重复代码

### 2.1 重复凭据验证逻辑 (低)

**位置**: 行 114-115 和 147-148

**代码**:
```python
# Oracle (行 114-115)
if not all([user, password, dsn]):

# OceanBase (行 147-148)
if not all([exe, host, port, user_string, password]):
```

**建议**: 提取为共享验证函数

### 2.2 重复错误处理模式 (低)

**位置**: 行 172-180

**问题**: 三个独立的 `if` 语句检查错误代码

**建议**: 使用字典映射错误代码到警告消息

---

## 3. 安全问题

### 3.1 命令行凭据暴露 (高)

**位置**: 行 161

**代码**:
```python
f"-p{password}"
```

**问题**: 密码直接传递给子进程命令，可在进程列表 (`ps aux`)、系统日志和 shell 历史中可见

**严重程度**: 高

**建议**: 使用环境变量或 stdin 传递凭据

### 3.2 路径遍历风险 (中)

**位置**: 行 220

**代码**:
```python
scenario_paths(args.scenario)
```

**问题**: 用户输入直接用于路径构建，可能导致路径遍历漏洞 (如 `--scenario ../../../etc/passwd`)

**严重程度**: 中

**建议**: 验证场景名称是否在白名单中，或使用 `Path.resolve()` 并检查父目录

---

## 4. 潜在缺陷

### 4.1 PL/SQL 状态管理问题 (中)

**位置**: 行 45-52, 82, 88, 95

**问题**: `flush()` 函数返回元组 `(False, False)`，但赋值解包可能不正确。`in_plsql` 标志在 flush 后总是重置为 False，可能导致连续 PL/SQL 块解析错误。

**建议**: 审查状态管理逻辑

### 4.2 静默错误继续 (中)

**位置**: 行 172-180

**问题**: ORA-01031, ORA-01920, ORA-00955 错误仅记录警告并继续执行，用户可能不知道某些设置步骤被跳过

**建议**: 将跳过的步骤记录到文件或要求明确确认才能继续

### 4.3 子进程无超时 (中)

**位置**: 行 167

**代码**:
```python
result = subprocess.run(cmd, text=True, capture_output=True)
```

**问题**: 如果 OceanBase 挂起，脚本将无限阻塞

**建议**: 添加超时参数 `timeout=300`

---

## 5. 代码质量问题

### 5.1 魔法字符串 (低)

**位置**: 行 172, 175, 178

**问题**: 硬编码 Oracle 错误代码

**建议**: 定义为模块级常量:
```python
IGNORABLE_ERRORS = {
    "ORA-01031": "insufficient privileges",
    "ORA-01920": "user already exists",
    "ORA-00955": "object already exists",
}
```

### 5.2 复杂嵌套逻辑 (低)

**位置**: 行 33-100

**问题**: `parse_sql_script` 函数圈复杂度高，嵌套条件多

**建议**: 将 PL/SQL 检测和缓冲区管理提取为独立辅助函数

---

## 6. 问题汇总表

| 问题 | 行号 | 严重程度 | 类型 |
|------|------|----------|------|
| 命令行密码暴露 | 161 | 高 | 安全 |
| 路径遍历风险 | 220 | 中 | 安全 |
| PL/SQL 状态管理 | 82, 88, 95 | 中 | 缺陷 |
| 静默错误继续 | 172-180 | 中 | 缺陷 |
| 无子进程超时 | 167 | 中 | 质量 |
| 魔法错误代码 | 172, 175, 178 | 低 | 质量 |
| 复杂解析逻辑 | 33-100 | 低 | 质量 |

---

## 7. 优先修复建议

1. **修复凭据暴露** (行 161) - 使用环境变量传递密码
2. **添加路径遍历保护** (行 220) - 验证场景名称
3. **审查 PL/SQL 解析逻辑** (行 82-95) - 验证状态管理正确性
4. **添加子进程超时** (行 167) - 防止无限挂起
5. **提取魔法字符串** (行 172-180) - 使用常量定义错误代码

---

*审查工具: Claude Code (claude-opus-4-5-20251101)*
